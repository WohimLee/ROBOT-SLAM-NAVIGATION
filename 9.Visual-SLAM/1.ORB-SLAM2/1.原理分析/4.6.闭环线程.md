&emsp;
# 闭环线程
当局部建图线程中处理后的每个当前关键帧，都要送入闭环线程，一旦回环检测通过，就对全局地图进行回环修正。闭环线程主要包括候选回环、计算相似变换、回环融合和位姿图优化

<div align="center">
    <image src="./imgs/4-1.png" width = >
    <h4></h>
</div>


&emsp;
## 1 候选回环
利用词袋模型，将数据库中与当前关键帧相似度较高的帧挑选出来，这些帧就是候选回环帧。

&emsp;
## 2 计算相似变换
计算当前关键帧与每个候选回环帧之间的变换关系，因为单目 SLAM 存在尺度漂移问题，所以当前关键帧与候选回环帧之间的变换出来包含旋转平移 $[\pmb{R} | \pmb{t}]$ 外，还包含一个尺度因子 s。也就是说，与计算相邻两帧间的变换 $\pmb{T}$ 不同，这里计算的是相似变换，具体计算方法与多视图几何的 3D-3D 模型类似。

如果有足够多的数据能计算出相似变换 $[s\pmb{R} | \pmb{t}]$，并且该变换能保证当前关键帧与候选回环帧之间有足够多的共视点，则接纳这个候选回环帧，回环检测成功

&emsp;
## 3 回环融合
当前关键帧与被接纳的候选回环帧之间的相似变换量描述了累积误差的大小，可以利用该变换量修正当前关键帧及其邻近关联帧的累积误差，并将哪些因累积误差而不一致的地图点融合到一起


&emsp;
## 4 位姿图优化
虽然回环融合可以修正当前关键帧及其邻近关联帧的累积误差，但是地图中那些与当前关键帧无共视关系的帧还没有得到修正，因此需要用全局优化来修正。

考虑计算效率的问题，这里的全局优化只将全局地图上的关键帧位姿量当成优化变量，而地图点并不是优化变量，这种优化也称为位姿图优化


