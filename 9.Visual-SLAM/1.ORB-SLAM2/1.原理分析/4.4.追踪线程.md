&emsp;
# 追踪线程
>追踪线程主要任务
- 追踪线程从相机获取输入图像，进行ORB特征提取
- 单目相机需要先完成地图初始化，在已有地图云点的基础上才能执行追踪任务
- 输出每帧图像的相机位姿信息用于定位
- 从众多的输入的图像中挑选具有代表性的关键帧（给接下来的局部建图线程）

<div align="center">
    <image src="./imgs/4-1.png" width = >
    <h4></h>
</div>

&emsp;
## 1 特征提取
每个从相机输入到追踪线程的图像都要先提取 ORB 特征，特征提取步骤包括：
- 构建图像金字塔
- 提取 FAST 及欧典
- 计算特征描述子

ORB 为了让特征点在图像中分布尽量均匀，这里的提取过程加入了一个格外要求，就是将图像划分成网格，每个网格内必须要提取出一定数量的角点

&emsp;
## 2 定位

追踪的目的就是为了实时确定相机在世界坐标系中的位姿，也就是定位。而定位常常分为：
- 粗定位：快速获得一个不太精确的初始位姿估计
- 精定位：在初始位姿估计（粗定位）的基础上通过复杂运算得到更精确的位姿估计

&emsp;
### 2.1 初始位姿估计（粗定位）
初始位姿估计涉及 `3 个计算模型`，它们的关系就是不断扩大追踪搜索范围。每个计算模型的追踪实现基本都一样：
- 先让当前帧与追踪帧匹配
- 接着构建多视图几何中的 $3D-2D$ 模型，用 $PnP$ 算法求解
- 对解出来的 $\pmb{T}$ 进一步优化
- 最后判断追踪成功与否

<div align="center">
    <image src="./imgs/4.4-1.png" width = >
    <h4>初始位姿估计</h>
</div>


>（1）追踪上一帧 TODO
- 如果上一帧输入的图像 $F_{k-1}$ 被追踪成功了，那么假设相机以 $F_{k-1}$ 时刻的速度匀速运动，得到了当前帧图像 $F_k$。

- 其实就是匀速模型，过程如下
    - 利用 $F_{k-1}$ 时刻的角速度和线速度乘以时间间隔，就可以估算出 $F_{k-1}$ 到 $F_k$ 相机的 $\pmb{T}$
    - 将图像 $F_{k-1}$ 中观测到的地图云点，通过 $\pmb{T}$ 变换到图像 $F_k$  坐标系
    - 利用地图云点投影到当前图像 $F_k$ 的关系
    - 最小化重投影误差来进一步解算 $\pmb{T}$ 更精确的值

- 这就是 $3D-2D$ 模型，可以用 $PnP$ 问题的各种算法进行求解。

&emsp;
>（2）追踪参考关键帧
- 如果相机运动太快或者相机运动过程中有抖动等因素，导致上面用匀速模型计算出的 $\pmb{T}$ 不正确（匀速模型追踪失败）。

- 这时要扩大追踪的搜索范围，及局部地图上的一系列关键帧。

- 利用词袋模型：
    - 首先将当前帧图像 $F_k$ 转换成表征向量
    - 然后利用表征向量将当前帧图像 $F_{k}$ 与局部地图中的一些列关键帧图像进行快速匹配
    - 局部地图中与当前帧匹配度最高的帧被称为 `参考关键帧`。
    
- 如果参考关键帧与当前帧的匹配较好（匹配点对数不小于15），就可以利用待求量 $\pmb{T}$ 将参考帧中观测到的地图云点变换到图像 $F_{k1}$ 坐标系
- 然后利用地图云点投影到当前图像 $F_{k}$ 的关系
- 最小化重投影误差来求 $\pmb{T}$ 
- 这就是 $3D-2D$ 模型，可以用 $PnP$ 问题的各种算法进行求解。


&emsp;
>（3）重定位
- 如果参考关键帧与当前帧的匹配并不好，或者求出的位姿上观测不到足够的地图点，那么参考关键帧追踪也就失败了。这时就要进行重定位

- 首先利用词袋模型将当前帧图像 $F_{k}$ 转换成表征向量
- 然后到全局关键帧的在线数据库中检索出相似度较高的一些关键帧——`候选关键帧`
- 将 $F_k$ 与候选关键帧中的每个帧进行匹配，挑出匹配较好（匹配点对数 $\geq 15$ ）
- $PnP$ 的 $RANSAC$ 迭代（这里用的是 $P4P$）
    >$PnP$ 的 $RANSAC$
    - 将每一个从候选关键帧挑出来的`匹配较好的帧`所能观测到的`地图云点`准备好
    - 用 $RANSAC$ 将上一步的地图云点，选 4 个在同一帧上的云点
    - 利用 $P4P$ 求出对应的 $\pmb{T}$ 

- 每次 $RANSAC$ 迭代后，都要判断在求出的当前帧图像 $F_k$ 位姿上能否观测到足够多的地图云点（$\geq50$），如果 $\geq50$，立刻结束 $RANSAC$ 迭代，说明重定位成功

- 如果经过所有的 $RANSAC$ 迭代后，重定位仍然不成功，就说明这是追踪处于彻底丢失（LOST）状态，只能将整个 SLAM 系统重启

&emsp;
>总结



&emsp;
### 2.2 局部地图追踪（精定位）
在上面的初始位姿估计中
- 采用匀速模型追踪上一帧图像
- 在局部地图上追踪参考关键帧
- 全局地图上重定位

本质上都是利用当前帧与追踪帧之间的 `共视地图云点` 来求相机位姿。显然两帧图像之间的共视点是很有限的，即当前帧中提取出的很多特征点并没有用于构建共视关系

局部地图追踪，就是在初始位姿估计完成的基础上，利用当前帧与局部地图上的多个关键帧建立共视关系，并利用所有这些共视地图云点与当前帧的投影关系，对相机的位姿进行更精确求解。

当然要根据一些严苛的条件先将共视地图云点中的一些外点去除，然后构建多视图几何中的 3D-2D 模型，最小化重投影误差对 $\pmb{T}$ 进行优化求解


&emsp;
## 3 新关键帧挑选

追踪线程最后一步就是新关键帧的挑选，按照一定的条件尽可能快速从普通帧中挑选出有代表性的帧

挑选关键帧的条件：
- 与上一个挑选的关键帧有足够的时间间隔
- 帧中药能观测到足够多的地图云点等

这里的快速挑选指初步的筛选，在局部建图线程中还要经过严苛的条件判断是否将其纳入地图中

