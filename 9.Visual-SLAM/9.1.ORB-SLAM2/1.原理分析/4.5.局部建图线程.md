&emsp;
# 局部建图线程
追踪线程挑选 `关键帧` 的速度较快，所以被挑选出来的关键帧存放在 `缓冲区` 内。局部建图线程不断从该缓冲区去除关键帧进行处理，更新当下的局部地图，并将每一个处理过的当前关键帧输出给闭环检测线程。

局部建图线程主要包括：
- 关键帧插入
- 近期地图点筛选
- 新地图云点重建
- 局部 BA 优化
- 局部关键帧筛选

<div align="center">
    <image src="./imgs/4-1.png" width = >
    <h4></h>
</div>

&emsp;
## 1 关键帧插入
每个从缓冲区取出来的关键帧
- 首先需要在词袋模型中计算表征向量，其实就是将该关键帧更新到词袋模型的在线数据库，以便后续计算之用
- 然后将地图中的哪些有共视关系但没有与该帧建立映射的云点建立关联，这些新建立关联的云点被称为 `近期地图点`
- 接着计算该关键帧与地图中的已有关键帧的公式连接权重，其实就是新建连接边，将该关键帧添加到共视关系图
- 最后将该关键帧添加到地图结构之中，这个关键帧插入就完成了


&emsp;
## 2 近期地图点筛选
在关键帧的插入过程中，保留了一些近期地图点，必须将其中一些质量差的云点剔除，比如被同时观测的关键帧数少、上一个能观测到的关键帧距离当前帧太久远等，这是维护地图点鲁棒性的重要机制


&emsp;
## 3 新地图云点重建
对于每一个新插入的关键帧，借助共视关系图与邻近的关键帧进行匹配，将该关键帧中还未映射到地图云点的特征点进行三角化重建，以生成新地图云点。

这个过程其实就是多视图几何中的 2D-2D 模型。

重建出的新地图点，如果检验合格就被添加到地图结构，同时被保留为近期地图点。因为缓冲区中关键帧的插入操作需要进行多次循环，这个过程在逻辑上实际是相互包含和穿插的


&emsp;
## 4 局部 BA 优化
缓冲区的关键帧都被取出来并处理后，就可以将当前帧局部的几个关键帧以及地图云点放入局部 BA 中优化。我们把各个关键帧和地图云点看成节点，一致其初始位姿；而关键帧与关键帧之间的约束边由公式关系给出，关键帧与地图云点之间的约束由投影关系给出


&emsp;
## 5 局部关键帧筛选

当局部 BA 优化完成后，需要对局部地图中的关键帧进行一次筛选，将哪些冗余的关键帧剔除，以保证地图中关键帧的鲁棒性

&emsp;
## 6 总结
上面的5个步骤并不是简单的顺序执行，因为缓冲区中有多个关键帧需要处理，所以这5 个步骤实际上是以循环和条件判断混合的方式出现