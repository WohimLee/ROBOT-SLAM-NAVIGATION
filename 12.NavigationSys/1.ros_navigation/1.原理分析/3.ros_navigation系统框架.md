&emsp;
# ros_navigation 系统框架

ros-navigation 是一个功能包集，里面包含了大量的ROS 功能包以及各种算法的具体实现节点。这些节点可以分为3类：
- 必要节点：move_base
- 可选节点：amcl、map_server
- 机器人平台相关节点：sensor transforms、odometry source、sensor sources、base controller

其中最核心的 move_base 通过插件机制（plugin）组织代码，这使得 move_base 中的 global_planner、local_planner、global_cosmap、local_cosmap、recovery_behaviors 等算法能被轻易替换和改进

&emsp;
<div align="center">
    <image src="./imgs/1.3-1.png" width = 800>
    <h4>ros_navigation 框架</h>
</div>

- map_server 节点扮演地图供应者角色
- amcl 节点扮演定位信息提供者角色，
- 传感器驱动节点和里程计节点分别扮演障碍信息反馈和运动反馈角色
- 底盘控制节点扮演执行器角色

&emsp;
## 1 定位
定位解决了机器人与障碍物之间的关联问题，因为路径规划本质上就是基于机器人周围障碍物进行决策的过程。比如，机器人导航到某个地方时发现环境变化导致原有路径无法通行了，此时就必须重新规划从当前定位点到目标点的路径，这个过程就是 `全局定位` 和 `全局路径规划`。

全局定位的可靠性直接决定了导航任务能否成功。比如开车从广州到北京，如果定位系统出错把你定位到了别的地方，那么这个路线肯定有问题。

只要已知机器人全局定位并借助激光雷达等传感器扫描信息实时避障，理论上就能完成导航任务。但全局定位的实时性和精度一般不高，所以将全局定位作为轨迹跟踪的反馈信号是行不通的。而相邻两个全局定位点之间更细颗粒度的定位点由论事里程计、IMU 等局部定位提供，就称保证轨迹跟踪调度实时性和精度。

ros-navigation 中的 amcl 节点通过发布 map->odom 的 tf 关系来提供全局定位。amcl 全局定位并不是必需的，可以将 amcl 全局定位替换成其它能提供 map->odom 的 tf 关系的全局定位（比如 SLAM、UWB、二维码定位等）。


定位解决了机器人与障碍物之间的关联问题，广义上应该说是 tf 关系解决了机器人与障碍物之间的关联问题。
- 比如激光雷达探测到前方 3m 处有一个障碍物，那么利用激光雷达与机器人底盘之间的 tf 关系（base_link->laser_link），就可以知道该障碍物与机器人底盘之间的关系；
- 再比如借助全局定位和局部定位提供的 tf 关系（map->odom->base_link），可以知道静态地图中障碍物与机器人底盘之间的关系

除了利用 tf 关系完成机器人与障碍物之间的关联外，我们还需要利用机器人机械模型 urdf 来完成控制策略与细粒度控制量之间的关联

&emsp;
## 2 障碍度量
ros-navigation 采用代价地图（costmap）对障碍物进行同一度量。代价地图分为：
- 全局代价地图（global_costmap）：为全局路径规划提供障碍度量
- 局部代价地图（local_costmap）：为局部路径规划提供障碍度量

我们可以选择所需的图层来构建全局代价地图和局部代价地图，每个图层中的障碍信息由下面模块提供：
- 静态地图
- 传感器（比如激光雷达、红外、超声波等）
- 特殊程序（比如行人检测、危险区标记、物体识别等）等

&emsp;
## 3 路径规划
路径规划在 ros-navigation 中分为：
- 全局路径规划（global_planner）：需要考虑全局，规划处一条尽量短，并且易于执行的路径
- 局部路径规划（local_planner）：在全局路径的指导下，机器人还要考虑周围实时的障碍物并指定避让策略

机器人的自主导航最终是由局部路径规划一步步完成的：
- 全局路径规划
    - 输入：目标点、机器人全局定位、全局代价地图
    - 输出：全局路径
- 局部路径规划
    - 输入：全局路径、机器人局部定位、局部代价地图
    - 输出：实际控制量

&emsp;
## 4 恢复策略
ros-navigation 提供了全局代价地图和局部代价地图之间的恢复策略（reconvery_behaviors）。

机器人在实际导航过程中很容易陷入困境，即机器人被障碍物覆盖或包围：
- 比如机器人不小心撞上了障碍物，此时障碍物已经出现在机器人机械模型内部区域，路径规划肯定会失败
- 或者机器人行驶到了某个狭窄的死胡同，由于传感器盲区和测量精度等，机器人退不出来
- 或者由于定位出错，机器人出现在某个障碍物包围区等

导致机器人陷入困境的因素有：
- 机器人打滑或机器人绑架导致的定位丢失
- 传感器自身缺陷（盲区、噪声、精度等）导致噪声障碍物被引入或者已消失的动态障碍无法计时清楚
- 机器人与障碍发生碰撞等

恢复策略就是让机器人从困境中摆脱出来的策略，比如执行原地旋转来强制清楚代价地图中的残留障碍，或者以非常小的速度尝试前进或者倒退来脱离障碍物包围等